<template>
  <div class="container mb-5">
    <button class="btn btn-light" @click.prevent="getNextRequest">NÃ¤chste Anfrage</button>
    <div v-if="loading" class="spinner-border" role="status">
      <span class="sr-only">Loading...</span>
    </div>
    <p>Datum der Kontrollberichte in dieser Anfrage:
      <small v-for="d in reportDates" :key="d">{{ d }},</small>
    </p>
    <food-report-request v-if="request"
      :request="request"
      :config="config"
      @addreport="addReport"
    ></food-report-request>
  </div>
</template>

<script>

import FoodReportRequest from './food-report-request'

import {getData, postData} from 'froide/frontend/javascript/lib/api.js'

export default {
  name: 'food-report',
  mixins: [],
  components: {
    FoodReportRequest
  },
  props: {
    config: {
      type: Object
    },
  },
  mounted () {
    this.getNextRequest()
  },
  data () {
    this.$root.csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value
    
    return {
      request: null,
      loading: false,
      reportDates: []
    }
  },
  computed: {
    csrfToken () {
      return this.$root.csrfToken
    },

  },
  methods: {
    addReport (data) {
      if (data.reportdate) {
        this.reportDates.push(data.reportdate)
      }
      this.loading = true
      postData('', data, this.$root.csrfToken).then((result) => {
        this.loading = false
        if (data.unresolved) {
          this.getNextRequest()
        }
      })
    },
    getNextRequest () {
      this.reportDates = []
      this.loading = true
      getData('').then((response) => {
        if (response.foirequest === null) {
          alert('Keine weiteren Anfragen mehr')
          return
        }
        getData(`/api/v1/request/${response.foirequest}/`).then((data) => {
          this.request = data
          this.loading = false
        })
      })
    }
  }
}
</script>


<style lang="scss" scoped>
  .loading {
    height: 100vh;
    padding-top: 30%;
    background-color: #fff;
    // animation: blinker 0.8s linear infinite;
    text-align: center;
  }

  .loading img {
    width: 10%;
  }

  @keyframes blinker {
    50% {
      opacity: 0.25;
    }
  }
</style>